{% extends "base.html" %}
{% load serebii_utils %}
{% block title %}Voting{% endblock %}

{% block active_voting %} class="active"{% endblock %}

{% block content %}
<h1>Voting</h1>

{% if not phase == 'voting' %}
<p>The voting phase {% if phase < 'voting' %}has not started.{% if phase == 'nomination' %} <a href="{% url 'nomination' %}">Click here to enter your nominations.</a>{% endif %}{% else %}is over. Come back in time for next year's awards!{% endif %}</p>
{% elif not user.is_authenticated %}
<p><strong>It is highly recommended that you <a href="{% url 'register' %}">register</a> to vote.</strong> Doing so will allow you to return at any time during the voting phase to change your votes if you so desire and eliminates the need to manually confirm your identity on the forums after voting.</p>

<p>However, if you'd rather not register, it is also possible to vote without it and be manually verified after submitting your votes. To do so, enter the link to your Serebii.net forums user profile into the form field below and press Continue. You can get this link by clicking <a href="http://www.serebiiforums.com/member.php" target="_blank">here</a> and copying the address it redirects you to, provided you are logged in to the forums.</p>

<form action="{% url 'voting' %}" method="post">
{% csrf_token %}
{% include 'form.html' %}
<p><button type="submit" class="btn btn-primary">Continue</button></p>
</form>
{% elif not user.member %}
<p>To vote, you must <a href="{% url 'verification' %}">verify your account</a>.</p>
{% else %}
<p>Here, you can submit your votes for the {{year}} fanfic awards.</p>

<p>You must place a vote in <strong>at least half of the available categories, rounded up</strong>. This is intended to encourage you to broaden your horizons and read more stories, rather than only voting in those categories your existing favorite fics happen to be nominated in. If you can't muster a vote in half of the categories, read some of the stories nominated in other categories - you may find some new favorites!</p>

<form action="{% url 'voting' %}" method="post">
{% csrf_token %}
{% if form.non_field_errors %}
<div class="alert alert-danger">{{form.non_field_errors}}</div>
{% elif form.errors %}
<div class="alert alert-danger">
<p>There were some problems with your votes. Please review the following categories:</p>
{% voting_form_errors %}
</div>
{% endif %}

{% include "nomination_list.html" %}

<p><button type="submit" class="btn btn-primary">Submit Votes</button></p>
</form>
{% endif %}
{% endblock %}

{% block scripts %}
<script>

    // Add progress pop-up
    $("body").append(`<div id="progress-tracker" class="collapse-container"><div class="collapse-marker collapse-button"><span class="glyphicon glyphicon-chevron-up"></span> Your Votes (<span id="current-vote-field">0</span>/{{award_requirement}})</div><div class="collapse-body"><span class="glyphicon glyphicon-chevron-down collapse-button pull-right"></span> You need to cast <span id="required-vote-field" class="collapse-button">0</span> more vote(s).</div></div>`);

    function update_progress() {

        var current_votes = 0;
        var voted_categories = {};
        var unvoted_categories = {};

        $("fieldset").each(function() {
            vote = $(this).find("input:checked").val();
            if (typeof vote !== 'undefined') {
                if (vote === "") {
                    unvoted_categories[$(this).attr("id")] = $(this).find("legend").text();
                }
                else {
                    voted_categories[$(this).attr("id")] = $(this).find("legend").text();
                }
            }
        });

        var $progress_list = $("#progress-tracker .collapse-body");
        // Remove any existing lists
        $progress_list.children(":not(.collapse-button)").remove();

        // Add uncast vote list
        $progress_list.append('<h4>Uncast Votes</h4>');
        var $unvoted_list = $('<ul class="list-unstyled">');

        if (Object.keys(unvoted_categories).length > 0) {
            for (var cat in unvoted_categories) {
                $unvoted_list.append($(`<li><a href="#${cat}">${unvoted_categories[cat]}</a></li>`));
            }
        }
        else {
            $unvoted_list.append($("<li>None</li>"));
        }

        $progress_list.append($unvoted_list);

        // Add cast vote list
        $progress_list.append('<h4>Cast Votes</h4>');
        var $voted_list = $('<ul class="list-unstyled">');

        if (Object.keys(voted_categories).length > 0) {

            current_votes = Object.keys(voted_categories).length;

            for (var cat in voted_categories) {
                $voted_list.append($(`<li><a href="#${cat}">${voted_categories[cat]}</a></li>`));
            }
        }
        else {
            $voted_list.append($("<li>None</li>"));
        }

        $progress_list.append($voted_list);

        // Update number of votes cast/needed
        $("#current-vote-field").text(current_votes);
        $("#required-vote-field").text(({{award_requirement}} - current_votes) >= 0 ? {{award_requirement}} - current_votes : 0);
    };

    // Populate progress with initial votes
    update_progress();

    // Update whenever a vote is cast or rescinded
    $(".nomination input").change(update_progress);


</script>
{% endblock %}
